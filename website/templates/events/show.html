{% extends 'base.html' %}
{% from 'bootstrap5/form.html' import render_form %}

{% block title %}
EventFinder | {{ event.title }}{% if event.venue %} @ {{ event.venue }}{% endif %}{% if event.genre %} ({{ event.genre
}}){% endif %}
{% endblock %}

{% block content %}
<div class="container mt-5">
  <!-- Centered Event Image -->
  <div class="text-center mb-4">
    <img
      src="{{ event.image }}"
      alt="{{ event.title }}"
      class="img-fluid rounded shadow-sm"
      style="max-width: 600px"
    />
  </div>

  <div class="row mt-5 mb-3">
    <!-- Left column: Event Info -->
    <div class="col-lg-8 mb-5">
      <h1 class="fw-bold mb-3">{{ event.title }}</h1>

      <div class="mb-4">
        <h4 class="fw-semibold mb-3 border-bottom pb-2">Details</h4>

        <ul class="list-unstyled mb-0">
          <li class="mb-2">
            <strong>Venue:</strong> {{ event.venue or "Venue TBA" }}
          </li>
          <li class="mb-2">
            <strong>Genre:</strong> {{ event.genre or "Unspecified" }}
          </li>
          <li class="mb-2">
            <strong>Date:</strong>
            {{ event.date.strftime('%a, %-d %b %Y') if event.date else "TBA" }}
          </li>
          <li class="mb-2">
            <strong>Door Time:</strong>
            {{ event.door_time.strftime('%I:%M %p') if event.door_time else "TBA" }}
          </li>
          <li class="mb-2">
            <strong>Start Time:</strong>
            {{ event.start_time.strftime('%I:%M %p') if event.start_time else "TBA" }}
          </li>
          <li class="mb-2">
            <strong>Status:</strong>
            {% if event.status == 'Open' %}
            <span class="badge bg-success">Open</span>
            {% elif event.status == 'Cancelled' %}
            <span class="badge bg-secondary">Cancelled</span>
            {% elif event.status == 'Sold Out' %}
            <span class="badge bg-danger">Sold Out</span>
            {% else %}
            <span class="badge bg-dark">Unknown</span>
            {% endif %}
          </li>
          <li>
            <strong>Created by:</strong>
            {{ event.creator.first_name }} {{ event.creator.last_name }}
          </li>
        </ul>
      </div>

      <div class="mb-5">
        <h4 class="fw-semibold mb-3 border-bottom border-secondary pb-2 text-white">Description</h4>
        <p class="text-light lh-lg" style="font-size: 1.05rem;">
          {{ event.description or "No description available." }}
        </p>
      </div>


      <div>
        <h4 class="fw-semibold mb-3 border-bottom pb-2">Comments</h4>

        {% if current_user.is_authenticated %}
        <!-- Comment form for logged-in users -->
        <div class="mb-4">
          {{ render_form(cform, "/events/{0}/comment".format(event.id)) }}
        </div>
        {% else %}
        <!-- Message + login link for guests -->
        <div class="alert alert-dark text-light bg-transparent border-secondary mb-4">
          <p class="mb-0">
            <a href="{{ url_for('auth.login') }}" class="text-info text-decoration-none fw-semibold">Log in</a>
            to post a comment.
          </p>
        </div>
        {% endif %}

        <!-- Existing comments -->
        {% for comment in event.comments %}
        <div class="border-bottom pb-2 mb-3">
          <strong>{{ comment.user }}</strong>
          <small class="text-muted ms-2">
            {{ comment.created_at.strftime("%a, %d %b %Y %I:%M %p") }}
          </small>
          <p class="mt-2 mb-0">{{ comment.text }}</p>
        </div>
        {% else %}
        <p class="text-muted">No comments yet. Be the first to share your thoughts.</p>
        {% endfor %}
      </div>

    </div>


    <!-- Right column: Ticket Info -->
    <div class="col-lg-4 col-md-5">
      <div class="sticky-top ticket-card">
        <div class="card shadow-sm mb-4">
          <div class="card-body">
            <h4 class="card-title">Tickets</h4>

            {% if event.status == "Open" %}
            <p><strong>Price per ticket:</strong> ${{ event.price }}</p>
            <p><strong>Available:</strong> {{ event.quantity }} tickets</p>
            <button
              type="button"
              class="btn btn-ticket w-100 mt-3"
              data-bs-toggle="modal"
              data-bs-target="#bookModal"
            >
              Purchase Tickets
            </button>
            {% else %}
            <p class="text-danger mb-0">
              <strong>Event is not open for booking.</strong>
            </p>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Booking Modal -->
      <div
        class="modal fade"
        id="bookModal"
        tabindex="-1"
        aria-labelledby="bookModalLabel"
        aria-hidden="true"
      >
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="bookModalLabel">Confirm Booking</h5>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
                aria-label="Close"
              ></button>
            </div>
            <div class="modal-body">
              {{ render_form(oform, url_for('event.purchase', id=event.id)) }}
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                Close
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
